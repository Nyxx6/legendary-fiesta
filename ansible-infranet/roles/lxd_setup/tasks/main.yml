---
- name: Create LXD networks
  shell: "lxc network create {{ item }} ipv6.dhcp=false ipv4.dhcp=false ipv6.nat=false ipv4.nat=false --type bridge || true"
  loop:
    - waf_net
    - back_net
    - redis_net

- name: Launch LXD containers
  shell: "lxc launch ubuntu:24.04 {{ item }} || true"
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis

- name: Wait for containers to be ready (Direct LXC check)
  shell: "lxc exec {{ item }} -- true"
  register: result
  until: result.rc == 0
  retries: 60
  delay: 5
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis

- name: Attach custom network interfaces (Preserving eth0 for management)
  shell: "lxc config device add {{ item.container }} {{ item.device }} nic nictype=bridged parent={{ item.network }} name={{ item.device }} || true"
  loop:
    # haproxy: eth0 (mgmt), eth1 (waf_net)
    - { container: 'haproxy', device: 'eth1', network: 'waf_net' }
    # wafs: eth0 (mgmt), eth1 (waf_net), eth2 (back_net)
    - { container: 'waf1', device: 'eth1', network: 'waf_net' }
    - { container: 'waf1', device: 'eth2', network: 'back_net' }
    - { container: 'waf2', device: 'eth1', network: 'waf_net' }
    - { container: 'waf2', device: 'eth2', network: 'back_net' }
    # webs: eth0 (mgmt), eth1 (back_net), eth2 (redis_net)
    - { container: 'web1', device: 'eth1', network: 'back_net' }
    - { container: 'web1', device: 'eth2', network: 'redis_net' }
    - { container: 'web2', device: 'eth1', network: 'back_net' }
    - { container: 'web2', device: 'eth2', network: 'redis_net' }
    - { container: 'web3', device: 'eth1', network: 'back_net' }
    - { container: 'web3', device: 'eth2', network: 'redis_net' }
    # redis: eth0 (mgmt), eth1 (redis_net)
    - { container: 'redis', device: 'eth1', network: 'redis_net' }

- name: Restart containers to apply hardware changes
  shell: "lxc restart {{ item }}"
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis

- name: Final wait for containers
  shell: "lxc exec {{ item }} -- true"
  register: result
  until: result.rc == 0
  retries: 60
  delay: 5
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis
