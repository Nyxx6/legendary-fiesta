---
- name: Attach custom network interfaces (Preserving eth0 for management)
  shell: "lxc config device add {{ item.container }} {{ item.device }} nic nictype=bridged parent={{ item.network }} name={{ item.device }} || true"
  loop:
    - { container: 'haproxy', device: 'eth1', network: 'waf_net' }
    - { container: 'waf1', device: 'eth1', network: 'waf_net' }
    - { container: 'waf1', device: 'eth2', network: 'back_net' }
    - { container: 'waf2', device: 'eth1', network: 'waf_net' }
    - { container: 'waf2', device: 'eth2', network: 'back_net' }
    - { container: 'web1', device: 'eth1', network: 'back_net' }
    - { container: 'web1', device: 'eth2', network: 'redis_net' }
    - { container: 'web2', device: 'eth1', network: 'back_net' }
    - { container: 'web2', device: 'eth2', network: 'redis_net' }
    - { container: 'web3', device: 'eth1', network: 'back_net' }
    - { container: 'web3', device: 'eth2', network: 'redis_net' }
    - { container: 'redis', device: 'eth1', network: 'redis_net' }

- name: Restart containers to apply hardware changes
  shell: "lxc restart {{ item }}"
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis

- name: Final wait for containers
  shell: "lxc exec {{ item }} -- true"
  register: result
  until: result.rc == 0
  retries: 60
  delay: 5
  loop:
    - haproxy
    - waf1
    - waf2
    - web1
    - web2
    - web3
    - redis
