user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
}

http {
	sendfile on;
	tcp_nopush on;
	types_hash_max_size 2048;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	# Logging format with security info
	log_format security '$remote_addr - $remote_user [$time_local] '
	                    '"$request" $status $body_bytes_sent '
	                    '"$http_referer" "$http_user_agent" '
	                    '"$http_x_forwarded_for" "$http_x_forwarded_proto"';

	access_log /var/log/nginx/access.log security;
	gzip on;

	# Real IP from HAProxy
	set_real_ip_from 20.0.0.0/24;
	real_ip_header X-Real-IP;
	real_ip_recursive on;

	# Upstream web servers
	upstream web_ssi {
		server 192.168.1.3:80; # Web1
		server 192.168.1.5:80; # Web3
	}
	upstream web_gil {
		server 192.168.1.3:80; # Web1
		server 192.168.1.4:80; # Web2
		server 192.168.1.5:80; # Web3
	}

	# WAF Server: receives HTTP from HAProxy
	server {
		listen 80;
		
		modsecurity on;
		modsecurity_rules_file /etc/nginx/modsec/main.conf;
		
		location / {
			if ($http_host = "healthcheck") {
				access_log off;
				return 200 "OK\n";
			}

			# Routing for ssi.local
			if ($host = "ssi.local") {
				proxy_pass http://web_ssi;
			}

			# Fallback to gil.local
			proxy_pass http://web_gil;

			# Preserve headers from HAProxy
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
			proxy_set_header X-Forwarded-Port $http_x_forwarded_port;
			
			# Additional proxy settings
			proxy_redirect off;
			proxy_buffering on;
			proxy_http_version 1.1;
		}
	}
}
