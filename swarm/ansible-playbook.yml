---
- name: Setup Templates
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Create templates directory
      file:
        path: templates
        state: directory

    - name: Create HAProxy config
      copy:
        dest: templates/haproxy.cfg
        content: |
          global
            daemon
            ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
          defaults
            mode http
            timeout connect 5000
            timeout client 50000
            timeout server 50000
          frontend http_front
            bind *:80
            redirect scheme https code 301
          frontend https_front
            bind *:443 ssl crt /etc/ssl/private/haproxy-ecdsa.pem crt /etc/ssl/private/haproxy-rsa.pem alpn h2,http/1.1
            http-response set-header Strict-Transport-Security "max-age=31536000"
            default_backend serveurswaf
          backend serveurswaf
            balance roundrobin
            server waf1 20.0.0.2:80 check
            server waf2 20.0.0.3:80 check

    - name: Create Nginx WAF config
      copy:
        dest: templates/nginx-waf.conf
        content: |
          user www-data;
          worker_processes auto;
          events { worker_connections 768; }
          http {
            include /etc/nginx/mime.types;
            set_real_ip_from 20.0.0.0/24;
            real_ip_header X-Real-IP;
            upstream web_ssi { server 192.168.1.3:80; server 192.168.1.5:80; }
            upstream web_gil { server 192.168.1.3:80; server 192.168.1.4:80; server 192.168.1.5:80; }
            server {
              listen 80;
              modsecurity on;
              modsecurity_rules_file /etc/nginx/modsec/main.conf;
              location / {
                if ($http_host = "healthcheck") { return 200; }
                if ($host = "ssi.local") { proxy_pass http://web_ssi; }
                proxy_pass http://web_gil;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
              }
            }
          }

    - name: Create Nginx Web config
      copy:
        dest: templates/nginx-web.conf
        content: |
          user www-data;
          worker_processes auto;
          events { worker_connections 768; }
          http {
            include /etc/nginx/mime.types;
            set_real_ip_from 192.168.1.0/24;
            real_ip_header X-Real-IP;
            include /etc/nginx/sites-enabled/*;
          }

    - name: Create site configs
      copy:
        dest: "{{ item.dest }}"
        content: "{{ item.content }}"
      loop:
        - dest: templates/ssi.conf
          content: |
            server {
              listen 80;
              server_name ssi.local;
              root /var/www/ssi;
              index index.html;
              location / { try_files $uri $uri/ =404; }
            }
        - dest: templates/gil.conf
          content: |
            server {
              listen 80;
              server_name gil.local;
              root /var/www/gil;
              index index.html;
              location / { try_files $uri $uri/ =404; }
            }
        - dest: templates/apache-gil.conf
          content: |
            <VirtualHost *:80>
                ServerName gil.local
                DocumentRoot /var/www/gil
                <Directory /var/www/gil>
                    Require all granted
                </Directory>
            </VirtualHost>
        - dest: templates/index-ssi.html
          content: |
            <!DOCTYPE html>
            <html><head><meta charset="UTF-8"><title>SSI Website</title></head>
            <body><h1>Site SSI</h1><p><strong>Bienvenue sur le site SSI</strong></p></body></html>
        - dest: templates/index-gil.html
          content: |
            <!DOCTYPE html>
            <html><head><meta charset="UTF-8"><title>GIL Website</title></head>
            <body><h1>Site GIL</h1><p><strong>Bienvenue sur le site GIL</strong></p></body></html>

- name: Deploy LXD Infrastructure
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    containers:
      - { name: web1, image: "ubuntu:24.04" }
      - { name: web2, image: "ubuntu:24.04" }
      - { name: web3, image: "ubuntu:24.04" }
      - { name: waf1, image: "ubuntu:24.04" }
      - { name: waf2, image: "ubuntu:24.04" }
      - { name: haproxy, image: "ubuntu:24.04" }
      - { name: redis, image: "ubuntu:24.04" }
    networks:
      - { name: back_net, ipv4: "192.168.1.1/24", nat: false }
      - { name: waf_net, ipv4: "20.0.0.1/24", nat: false }
      - { name: redis_net, ipv4: "30.0.0.1/24", nat: false }

  tasks:
    - name: Create LXD networks
      command: >
        lxc network create {{ item.name }}
        ipv4.address={{ item.ipv4 }}
        ipv4.dhcp=false ipv4.nat={{ item.nat }}
        ipv6.dhcp=false ipv6.nat=false
      loop: "{{ networks }}"
      ignore_errors: yes

    - name: Launch containers
      command: lxc launch {{ item.image }} {{ item.name }}
      loop: "{{ containers }}"
      ignore_errors: yes

    - name: Wait for containers
      command: lxc exec {{ item.name }} -- systemctl is-system-running --wait
      loop: "{{ containers }}"
      retries: 30
      delay: 2
      register: result
      until: result.rc == 0
      ignore_errors: yes

    - name: Generate SSL certificates locally
      block:
        - file: path=ssl_certs state=directory
        - shell: |
            openssl genrsa -out ssl_certs/ca-key.pem 4096 2>/dev/null
            openssl req -new -x509 -days 3650 -key ssl_certs/ca-key.pem -sha256 \
              -out ssl_certs/ca.pem -subj "/C=FR/ST=IDF/L=Paris/O=Infra/CN=RootCA" 2>/dev/null
            
            cat > ssl_certs/ext.cnf << 'EOF'
            subjectAltName = DNS:*.local,IP:20.0.0.1
            keyUsage = digitalSignature, keyEncipherment
            extendedKeyUsage = serverAuth
            EOF
            
            openssl ecparam -genkey -name prime256v1 -out ssl_certs/haproxy-ecdsa-key.pem 2>/dev/null
            openssl req -new -key ssl_certs/haproxy-ecdsa-key.pem -out ssl_certs/haproxy-ecdsa.csr \
              -subj "/C=FR/ST=IDF/L=Paris/O=Infra/CN=haproxy.local" 2>/dev/null
            openssl x509 -req -days 365 -in ssl_certs/haproxy-ecdsa.csr \
              -CA ssl_certs/ca.pem -CAkey ssl_certs/ca-key.pem -CAcreateserial \
              -out ssl_certs/haproxy-ecdsa-cert.pem -sha256 -extfile ssl_certs/ext.cnf 2>/dev/null
            cat ssl_certs/haproxy-ecdsa-cert.pem ssl_certs/haproxy-ecdsa-key.pem > ssl_certs/haproxy-ecdsa.pem
            
            openssl genrsa -out ssl_certs/haproxy-rsa-key.pem 2048 2>/dev/null
            openssl req -new -key ssl_certs/haproxy-rsa-key.pem -out ssl_certs/haproxy-rsa.csr \
              -subj "/C=FR/ST=IDF/L=Paris/O=Infra/CN=haproxy.local" 2>/dev/null
            openssl x509 -req -days 365 -in ssl_certs/haproxy-rsa.csr \
              -CA ssl_certs/ca.pem -CAkey ssl_certs/ca-key.pem -CAcreateserial \
              -out ssl_certs/haproxy-rsa-cert.pem -sha256 -extfile ssl_certs/ext.cnf 2>/dev/null
            cat ssl_certs/haproxy-rsa-cert.pem ssl_certs/haproxy-rsa-key.pem > ssl_certs/haproxy-rsa.pem
          args:
            creates: ssl_certs/haproxy-ecdsa.pem

- name: Configure Nginx Web Servers
  hosts: web1,web3
  gather_facts: no
  tasks:
    - name: Install Nginx + PHP
      apt:
        name: [nginx, php8.3-fpm, php8.3-cli]
        state: present
        update_cache: yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Attach to back_net
      shell: lxc network attach back_net {{ inventory_hostname }} eth0
      delegate_to: localhost
      ignore_errors: yes

    - name: Add eth1 device
      shell: lxc config device add {{ inventory_hostname }} eth1 nic nictype=bridged parent=redis_net
      delegate_to: localhost
      ignore_errors: yes

    - name: Wait for interfaces and configure
      shell: |
        for i in {1..10}; do [ -e /sys/class/net/eth0 ] && [ -e /sys/class/net/eth1 ] && break; sleep 1; done
        ip addr flush dev eth0
        ip link set dev eth1 up
        {% if inventory_hostname == 'web1' %}
        ip addr add 192.168.1.3/24 dev eth0
        ip addr add 30.0.0.3/24 dev eth1
        ip route add default via 192.168.1.1 dev eth0
        {% elif inventory_hostname == 'web3' %}
        ip addr add 192.168.1.5/24 dev eth0
        ip addr add 30.0.0.5/24 dev eth1
        ip route add default via 192.168.1.2 dev eth0
        {% endif %}
      ignore_errors: yes

    - name: Create web directories
      file: path={{ item }} state=directory owner=www-data group=www-data
      loop: [/var/www/ssi, /var/www/gil]

    - name: Deploy nginx configs
      copy:
        dest: "{{ item.dest }}"
        content: "{{ item.content }}"
      loop:
        - { dest: /etc/nginx/nginx.conf, content: "{{ lookup('file', 'templates/nginx-web.conf') }}" }
        - { dest: /etc/nginx/sites-enabled/ssi.conf, content: "{{ lookup('file', 'templates/ssi.conf') }}" }
        - { dest: /etc/nginx/sites-enabled/gil.conf, content: "{{ lookup('file', 'templates/gil.conf') }}" }
        - { dest: /var/www/ssi/index.html, content: "{{ lookup('file', 'templates/index-ssi.html') }}" }
        - { dest: /var/www/gil/index.html, content: "{{ lookup('file', 'templates/index-gil.html') }}" }

    - name: Create PHP-FPM socket symlink
      shell: |
        SOCK=$(ls /var/run/php/php*-fpm.sock 2>/dev/null | head -1)
        [ -n "$SOCK" ] && ln -sf "$SOCK" /var/run/php/php-fpm.sock
      ignore_errors: yes

    - name: Restart nginx
      systemd: name=nginx state=restarted enabled=yes

- name: Configure Apache Web Server
  hosts: web2
  gather_facts: no
  tasks:
    - name: Install Apache
      apt: name=apache2 state=present update_cache=yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Attach to back_net and add eth1
      shell: |
        lxc network attach back_net web2 eth0
        lxc config device add web2 eth1 nic nictype=bridged parent=redis_net
      delegate_to: localhost
      ignore_errors: yes

    - name: Wait for interfaces and configure network
      shell: |
        for i in {1..10}; do [ -e /sys/class/net/eth0 ] && [ -e /sys/class/net/eth1 ] && break; sleep 1; done
        ip addr flush dev eth0
        ip link set dev eth1 up
        ip addr add 192.168.1.4/24 dev eth0
        ip addr add 30.0.0.4/24 dev eth1
        ip route add default via 192.168.1.1 dev eth0
      ignore_errors: yes

    - file: path=/var/www/gil state=directory

    - copy:
        dest: "{{ item.dest }}"
        content: "{{ item.content }}"
      loop:
        - { dest: /etc/apache2/sites-available/gil.conf, content: "{{ lookup('file', 'templates/apache-gil.conf') }}" }
        - { dest: /var/www/gil/index.html, content: "{{ lookup('file', 'templates/index-gil.html') }}" }

    - shell: a2ensite gil && systemctl reload apache2

- name: Configure WAF Servers
  hosts: waf1,waf2
  gather_facts: no
  tasks:
    - name: Install Nginx + ModSecurity
      apt:
        name: [nginx, libnginx-mod-http-modsecurity, modsecurity-crs]
        state: present
        update_cache: yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Attach to waf_net and add eth1
      shell: |
        lxc network attach waf_net {{ inventory_hostname }} eth0
        lxc config device add {{ inventory_hostname }} eth1 nic nictype=bridged parent=back_net
      delegate_to: localhost
      ignore_errors: yes

    - name: Wait for interfaces and configure network
      shell: |
        for i in {1..10}; do [ -e /sys/class/net/eth0 ] && [ -e /sys/class/net/eth1 ] && break; sleep 1; done
        ip addr flush dev eth0
        ip link set dev eth1 up
        {% if inventory_hostname == 'waf1' %}
        ip addr add 20.0.0.2/24 dev eth0
        ip addr add 192.168.1.1/24 dev eth1
        {% else %}
        ip addr add 20.0.0.3/24 dev eth0
        ip addr add 192.168.1.2/24 dev eth1
        {% endif %}
        sysctl -w net.ipv4.ip_forward=1
      ignore_errors: yes

    - name: Setup ModSecurity
      shell: |
        mkdir -p /etc/nginx/modsec
        cp /etc/modsecurity/modsecurity.conf-recommended /etc/nginx/modsec/modsecurity.conf || \
          echo -e "SecRuleEngine On\nSecRequestBodyAccess On" > /etc/nginx/modsec/modsecurity.conf
        sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/nginx/modsec/modsecurity.conf
        echo 'Include /etc/nginx/modsec/modsecurity.conf' > /etc/nginx/modsec/main.conf
        echo 'Include /usr/share/modsecurity-crs/owasp-crs.load' >> /etc/nginx/modsec/main.conf
        sed -i 's/^IncludeOptional/Include/' /usr/share/modsecurity-crs/owasp-crs.load || true

    - copy:
        dest: /etc/nginx/nginx.conf
        content: "{{ lookup('file', 'templates/nginx-waf.conf') }}"

    - systemd: name=nginx state=restarted enabled=yes

- name: Configure HAProxy
  hosts: haproxy
  gather_facts: no
  tasks:
    - name: Install HAProxy
      apt: name=haproxy state=present update_cache=yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Configure network
      shell: |
        lxc config device add haproxy eth1 nic nictype=bridged parent=waf_net
      delegate_to: localhost
      ignore_errors: yes

    - name: Wait for interface and add IP
      shell: |
        for i in {1..10}; do [ -e /sys/class/net/eth1 ] && break; sleep 1; done
        ip link set dev eth1 up
        ip addr add 20.0.0.1/24 dev eth1
      ignore_errors: yes

    - name: Push SSL certificates
      shell: |
        lxc file push ssl_certs/haproxy-ecdsa.pem haproxy/etc/ssl/private/
        lxc file push ssl_certs/haproxy-rsa.pem haproxy/etc/ssl/private/
        lxc exec haproxy -- chown -R haproxy:haproxy /etc/ssl/private
        lxc exec haproxy -- chmod 600 /etc/ssl/private/haproxy-*.pem
      delegate_to: localhost

    - copy:
        dest: /etc/haproxy/haproxy.cfg
        content: "{{ lookup('file', 'templates/haproxy.cfg') }}"

    - systemd: name=haproxy state=restarted enabled=yes

- name: Configure Redis
  hosts: redis
  gather_facts: no
  tasks:
    - name: Install Redis
      apt: name=redis-server state=present update_cache=yes
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Attach to redis_net
      shell: lxc network attach redis_net redis eth0
      delegate_to: localhost
      ignore_errors: yes

    - name: Wait for interface and configure
      shell: |
        for i in {1..10}; do [ -e /sys/class/net/eth0 ] && break; sleep 1; done
        ip addr flush dev eth0
        ip addr add 30.0.0.1/24 dev eth0
      ignore_errors: yes

    - shell: |
        sed -i 's/bind 127.0.0.1 -::1/bind 30.0.0.1/' /etc/redis/redis.conf
        systemctl restart redis

- name: Destroy Infrastructure
  hosts: localhost
  connection: local
  gather_facts: no
  tags: [never, destroy]
  tasks:
    - name: Delete containers
      command: lxc delete {{ item }} --force
      loop: [web1, web2, web3, waf1, waf2, haproxy, redis]
      ignore_errors: yes

    - name: Delete networks
      command: lxc network delete {{ item }}
      loop: [back_net, waf_net, redis_net]
      ignore_errors: yes

    - name: Clean local files
      file:
        path: "{{ item }}"
        state: absent
      loop: [ssl_certs, templates]
